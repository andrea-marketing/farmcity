<div class="container">

  <!-- Back link  -->

   <%= link_to ("<i class='fa-solid fa-angle-left'></i> Back").html_safe, producers_path, class: "btn-link"%>

  <!-- Producer banner -->
  <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="true">
    <div class="carousel-indicators">
      <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
      <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1" aria-label="Slide 2"></button>
      <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="2" aria-label="Slide 3"></button>
    </div>
    <div class="carousel-inner">
      <% @producer.photos.each do |photo| %>
        <div class="carousel-item active">
          <%= cl_image_tag photo.key, height: 300, width: 400, crop: :fill %>
        </div>
      <% end %>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>

  <!-- Producer info -->
  <div class="intro">
    <h1><%=@producer.name.capitalize%>, <%=@producer.producer_type.capitalize%></h1>
    <p><strong><%=@producer.address%></strong></p>

      <!-- Producer favorite -->
    <div class="favorite">
      <% if @producer.favorites.exists? %>
        <% if @producer.favorite?(current_user)%>
          <p><%= link_to ("<i class='fa-regular fa-heart'></i>").html_safe, producer_favorites_path(@producer), method: :post %></p>
        <% else %>
          <p><%= link_to ("<i class='fa-solid fa-heart'></i>").html_safe, favorite_path(@producer.user_favorite(current_user)), method: :delete, data: { confirm: "Are you sure?" } %></p>
        <%end%>
      <% else %>
        <% if policy(Favorite).create? %>
          <p><%= link_to ("<i class='fa-regular fa-heart'></i>").html_safe, producer_favorites_path(@producer), method: :post %></p>
      <%end%>
    </div>
  </div>

  <br>
  <h2>Presentation</h2>
  <p><%=@producer.description%></p>
  <br>

  <p>For more informations, contact me at <%=@producer.contact%></p>

   <!-- Add/destroy producer  -->

  <div class="buttons">
    <% if policy(@producer).edit? %>
      <%= link_to "Update", edit_producer_path(@producer), class: "btn btn-red" %>
    <% end %>

    <% if policy(@producer).destroy? %>
      <%= link_to ("<i class='fa-regular fa-trash-can'></i> Delete producer").html_safe, producer_path(@producer),
                    method: :delete,
                    data: { confirm: "Are you sure?" } ,
                    class:"btn btn-red"%>
    <% end %>

  </div>

  <h2>Products</h2>
  <!-- New product  -->

  <% if policy(Product).create? %>
    <%= link_to ("<i class='fa-solid fa-plus'></i> Add Product").html_safe, new_producer_product_path(@producer, @product), class: "btn-link" %>
  <% end %>

  <!-- Product list -->

  <% @producer.products.each do |product| %>
    <div class="card-product">
      <% if product.photo.attached? %>
        <%= cl_image_tag product.photo.key, height: 300, width: 400, crop: :fill %>
      <% end %>
      <div class="card-product-infos">
        <h3><%= product.name %></h3>
        <p><%= product.category_list %></p>
        <p><%= product.description %></p>
        <p><%= product.price %></p>
      </div>
      <div class="buttons">
        <%= link_to ("<i class='fa-regular fa-pen-to-square'></i>").html_safe,  edit_producer_product_path(@producer, product), class: "btn-link" %>
        <%= link_to ("<i class='fa-regular fa-trash-can'></i>").html_safe,
            producer_product_path(@producer, product),
            method: :delete,
            class: "btn-link",
            data: { confirm: "Are you sure?" } %>
      </div>
    </div>
  <% end %>

  <% end %>



  <h2>Reviews</h2>

  <!-- New review  -->
  <% if policy(Review).create? %>
     <%= link_to ("<i class='fa-solid fa-comment-dots'></i> Leave a review").html_safe, new_producer_review_path(@producer), class: "btn-link" %>
  <%end%>


  <!--  Reviews -->

  <% @producer.reviews.each do |review| %>
    <div class="card-review">
      <div class="card-review-title">
        <p><%= review.rating %>/5 <i class='fa-solid fa-star'></i></p>
        <% if policy(review).destroy? %>
              <%= link_to ("<i class='fa-regular fa-trash-can'></i>").html_safe,
                        review_path(review),
                        method: :delete,
                        data: { confirm: "Are you sure?" },
                        class: "btn-link" %>
        <% end %>
      </div>
      <p><%= review.content %></p>
      <div class="card-review-user">
        <p><strong><%= review.user.first_name %></strong></p>
        <p><%= review.created_at %></p>
        <% console %>
        <%# <%= cl_image_tag review.user.photo, class: "avatar dropdown-toggle" %>
      </div>
    </div>
  <% end %>

    <h2>Markets</h2>

     <%= link_to ("<i class='fa-solid fa-plus'></i> Add Product").html_safe, new_producer_point_of_sale_path(@producer, @point_of_sale), class: "btn-link" %>

    <% @producer.point_of_sales.each do |point_of_sale| %>
      <% market = point_of_sale.market %>
      <%= link_to market_path(market) do %>
        <div class="">
          <h2 class=""><%= market.name.upcase %></h2>
            <p class="mt-3"><%= market.address %></p>
        </div>
        <div>
          <h2 class=""><%= market.description %></h2>
        </div>
      <% end %>

      <% if policy(point_of_sale).destroy? %>
        <%= link_to ("<i class='fa-regular fa-trash-can'></i> Delete Market").html_safe,
           producer_point_of_sale_path(@producer, point_of_sale),
          method: :delete,
          data: { confirm: "Are you sure?" },
          class: "btn btn-red" %>
      <%end%>
    <% end %>

     <div class="col-12">
    <div style="width: 100%; height: 100vh;"
        data-controller="mapbox"
        data-mapbox-markers-value="<%= @markers.to_json %>"
        data-mapbox-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>">
    </div>
</div>
